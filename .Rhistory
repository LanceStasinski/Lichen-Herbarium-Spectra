lmm_varslope_log = lmer(`700` ~ log(age) + (log(age)|scientificName), data = spec_df)
AIC(linear)
AIC(glm)
AIC(lmm)
AIC(lmm_varslope)
AIC(lmm_varslope_sqrt)
AIC(lmm_varslope_log10)
AIC(lmm_varslope_log)
lmm_varslope_log10_2 = lmer(log10(`700`) ~ log10(age) + (log10(age)|scientificName), data = spec_df)
lmm_varslope_sqrt_log10 = lmer(sqrt(`700`) ~ log10(age) + (log10(age)|scientificName), data = spec_df)
AIC(lmm_varslope_log10_2)
AIC(lmm_varslope_sqrt_log10)
lmm_varslope_log_log10 = lmer(log(`700`) ~ log10(age) + (log10(age)|scientificName), data = spec_df)
AIC(lmm_varslope_log_log10)
AIC(lmm_varslope_sqrt_log10)
summary(lmm_varslope_sqrt_log10)
#variable intercept, fixed slope - nested
mixed.lmer2 = lmer(`700` ~ age + (1|Class/Order/Family), data = spec_df)
AIC(mixed.lmer2)
lmm_fixedslope = lmer(sqrt(`700`) ~ log10(age) + (1|scientificName))
lmm_fixedslope = lmer(sqrt(`700`) ~ log10(age) + (1|scientificName), data = spec_df)
AIC(lmm_fixedslope)
summary(lmm_fixedslope)
boxplot(`700` ~ scientificName, data = spec_df)
boxplot(sqrt(`700`) ~ scientificName, data = spec_df)
summary(lmm_varslope_sqrt_log10)
(mm_plot <- ggplot(spec_df, aes(x = log10(age), y = sqrt(`700`))) +
facet_wrap(~scientificName, nrow=5) +   # a panel for each mountain range
geom_point(alpha = 0.5) +
theme_classic() +
geom_line(data = cbind(spec_df, pred = predict(lmm_fixedslope)), aes(y = pred), size = 1) +  # adding predicted line from mixed model
theme(legend.position = "none",
panel.spacing = unit(2, "lines"))  # adding space between panels
)
(mm_plot <- ggplot(spec_df, aes(x = log10(age), y = sqrt(`700`))) +
facet_wrap(~scientificName, nrow=5) +   # a panel for each mountain range
geom_point(alpha = 0.5) +
theme_classic() +
geom_line(data = cbind(spec_df, pred = predict(lmm_varslope_sqrt_log10)), aes(y = pred), size = 1) +  # adding predicted line from mixed model
theme(legend.position = "none",
panel.spacing = unit(2, "lines"))  # adding space between panels
)
spec_df = spec_df[length(unique(spec_df$X)) > 4, ]
spectra = readRDS('spectra/lichen_spectra.rds')
#4 scans per individual cannot be treated as independent in a linear model, so
#I'm taking the mean per individual
spectra = aggregate(spectra, by = meta(spectra)$X, mean, try_keep_txt(mean))
spec_df = as.data.frame(spectra)
spec_df = spec_df[nrow(unique(spec_df$scientificName)) > 4,]
unique(spec_df$scientificName)
spectra = readRDS('spectra/lichen_spectra.rds')
#4 scans per individual cannot be treated as independent in a linear model, so
#I'm taking the mean per individual
spectra = aggregate(spectra, by = meta(spectra)$X, mean, try_keep_txt(mean))
spec_df = as.data.frame(spectra)
uniqueNames = unique(spec_df$scientificName)
gc()
nameList = c()
for (i in 1:length(uniqueNames)) {
speciesSpec = spec_df[spec_df$scientificName == uniqueNames[i]]
if (nrow(speciesSpec > 4)) {
nameList = append(nameList, uniqueNames[i])
}
}
nameList = c()
for (i in 1:length(uniqueNames)) {
speciesSpec = spec_df[spec_df$scientificName == uniqueNames[i],]
if (nrow(speciesSpec > 4)) {
nameList = append(nameList, uniqueNames[i])
}
}
nameList = c()
for (i in 1:length(uniqueNames)) {
speciesSpec = spec_df[spec_df$scientificName == uniqueNames[i],]
if (nrow(speciesSpec) > 4) {
nameList = append(nameList, uniqueNames[i])
}
}
spec_df = spec_df[spec_df$scientificName %in% nameList, ]
length(unique(spec_df$scientificName))
lmm_varslope_sqrt_log10 = lmer(sqrt(`700`) ~ log10(age) + (log10(age)|scientificName), data = spec_df)
AIC(lmm_varslope_sqrt_log10) # best out of variable slope lmms
(mm_plot <- ggplot(spec_df, aes(x = log10(age), y = sqrt(`700`))) +
facet_wrap(~scientificName, nrow=5) +   # a panel for each mountain range
geom_point(alpha = 0.5) +
theme_classic() +
geom_line(data = cbind(spec_df, pred = predict(lmm_varslope_sqrt_log10)), aes(y = pred), size = 1) +  # adding predicted line from mixed model
theme(legend.position = "none",
panel.spacing = unit(2, "lines"))  # adding space between panels
)
pls = readRDS('models/order.rds')
library(corrplot)
library(matrixStats)
library(naniar)
library(spectrolab)
vip_to_spec = function(x){
t.vip = t(x[,-1])
colnames(t.vip) <- gsub("`", "", colnames(t.vip))
s.vip = as_spectra(t.vip)
plot(mean(s.vip), lwd = 1.5, lty = 1, ylim = c(0, 100),
ylab = "Variable Importance", xlab = "Wavelength (nm)", cex.lab = 1,
main = names(s.vip)[1])
plot_quantile(s.vip, total_prob = 0.95, col = rgb(0, 0, 0, 0.25),
border = FALSE, add = TRUE)
}
vip.list = pls[[1]]
par(mfrow = c(3,5))
for (j in 1:length(vip.list)) {
vip_to_spec(vip.list[[j]])
}
vip_to_spec = function(x){
t.vip = t(x[,-1])
colnames(t.vip) <- gsub("`", "", colnames(t.vip))
s.vip = as_spectra(t.vip)
plot(mean(s.vip), lwd = 1.5, lty = 1, ylim = c(0, 100),
ylab = "Variable Importance", xlab = "Wavelength (nm)", cex.lab = 1,
main = names(s.vip)[1])
plot_quantile(s.vip, total_prob = 0.95, col = rgb(0, 0, 0, 0.25),
border = FALSE, add = TRUE)
}
vip.list = pls[[1]]
par(mfrow = c(3,5))
for (j in 1:length(vip.list)) {
vip_to_spec(vip.list[[j]])
}
vip_to_spec = function(x){
t.vip = t(x[,-1])
colnames(t.vip) <- gsub("`", "", colnames(t.vip))
s.vip = as_spectra(t.vip)
plot(mean(s.vip), lwd = 1.5, lty = 1, ylim = c(0, 100),
ylab = "Variable Importance", xlab = "Wavelength (nm)", cex.lab = 1,
main = names(s.vip)[1])
plot_quantile(s.vip, total_prob = 0.95, col = rgb(0, 0, 0, 0.25),
border = FALSE, add = TRUE)
}
vip.list = pls[[1]]
par(mfrow = c(3,5))
for (j in 1:length(vip.list)) {
vip_to_spec(vip.list[[j]])
}
vip_to_spec = function(x){
t.vip = t(x[,-1])
colnames(t.vip) <- gsub("`", "", colnames(t.vip))
s.vip = as_spectra(t.vip)
plot(mean(s.vip), lwd = 1.5, lty = 1, ylim = c(0, 100),
ylab = "Variable Importance", xlab = "Wavelength (nm)", cex.lab = 1,
main = names(s.vip)[1])
plot_quantile(s.vip, total_prob = 0.95, col = rgb(0, 0, 0, 0.25),
border = FALSE, add = TRUE)
}
vip.list = pls[[1]]
par(mfrow = c(3,5))
for (j in 1:length(vip.list)) {
vip_to_spec(vip.list[[j]])
}
library(corrplot)
library(matrixStats)
library(naniar)
library(spectrolab)
################################################################################
#run plsda
################################################################################
spectra = readRDS('spectra/lichen_spectra.rds')
classify = readRDS("functions/plsda.rds")
pls = classify(spectra = spectra,
className = "Order",
ncomp = 60,
resampling = 'down',
n_iteration = 100,
include_age = T)
accuracy = pls[[4]]
mean(accuracy)
sd(accuracy)
################################################################################
a.fit = pls[[2]]
a.total = a.fit[,-1]
a.avg = as.matrix(rowMeans(a.total))
a.sd = as.matrix(rowSds(a.total))
a.lower = a.avg - a.sd
a.higher = a.avg + a.sd
#Graph to visually choose optimal number of components
x = 1:60
par(mar = c(5.1, 4.1, 4.1, 2.1), oma = c(5.1, 4.1, 4.1, 2.1))
plot(x, a.avg, type = 'p', pch = 16, cex = .75, ylab = 'Accuracy',
xlab = 'Component', xlim = c(1,60), main = 'Accuracy for Species_ID',
ylim = c(0,1))
arrows(x, a.lower, x, a.higher,length=0.05, angle=90, code=3)
abline(v = which.max(a.avg), col = 'blue')
abline(h = max(a.avg), col = "Red")
legend('bottomright', legend = c('Mean', 'Maximum accuracy','Best component'),
pch = c(16, NA, NA), lty = c(NA, 1, 1), col = c('black', 'red', 'blue'))
library(spectrolab)
library(lme4)
library(nlme)
library(ggplot2)
library(ggeffects)
library(sjPlot)
library(rlist)
spectra = readRDS('spectra/lichen_spectra.rds')
spectra = normalize(spectra)
#4 scans per individual cannot be treated as independent in a linear model, so
#I'm taking the mean per individual
#spectra = aggregate(spectra, by = meta(spectra)$X, mean, try_keep_txt(mean))
spec_df = as.data.frame(spectra)
int_r2_list = c()
slope_r2_list = c()
age_effect_list = c()
age_97.5_list = c()
age_2.5_list = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
lmm = lmer(sqrt(spec_df[, x]) ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
d = as.data.frame(VarCorr(lmm))
intercept_var = d[1,4]
slope_var = d[2,4]
residual_var = d[4,4]
total_var = sum(intercept_var, slope_var, residual_var)
int_r2 = intercept_var/total_var
int_r2_list = append(int_r2_list, int_r2)
slope_r2 = slope_var/total_var
slope_r2_list = append(slope_r2_list, slope_r2)
age_effect_list = append(age_effect_list, as.numeric(fixef(lmm)[2]))
ci = confint(lmm)
age_2.5_list = append(age_2.5_list, ci[6])
age_97.5_list = append(age_97.5_list, ci[12])
}
stats_list = list()
stats_list = list.append(stats_list, int_r2_list)
stats_list = list.append(stats_list, slope_r2_list)
stats_list = list.append(stats_list, age_effect_list)
stats_list = list.append(stats_list, age_97.5_list)
stats_list = list.append(stats_list, age_2.5_list)
saveRDS(stats_list, 'models/lmm_1_vn.rds')
wv = seq(400, 2400, 1)
plot(wv, abs(stats_list[[3]]),
type = 'l',
xlab = 'Wavelength (nm)',
ylab = 'Effect of age (log10(age)/sqrt(wavelength))',
ylim = c(min(stats_list[[5]]), max(stats_list[[4]])))
polygon(c(wv, rev(wv)), c(stats_list[[4]], rev(stats_list[[5]])),
col = 'grey80',
lty = 0)
lines(wv, stats_list[[3]])
plot(wv, stats_list[[1]],
type = 'l',
ylab = 'Percent variance explained',
xlab = 'Wavelength (nm)',
col = 'red',
ylim = c(0, 1))
lines(wv, stats_list[[2]], col = 'blue')
legend('topright',
c('Intercept', 'Slope'),
col = c('red', 'blue'), lty = c(1,1))
plot(wv, stats_list[[3]],
type = 'l',
xlab = 'Wavelength (nm)',
ylab = 'Effect of age (log10(age)/sqrt(wavelength))',
ylim = c(min(stats_list[[5]]), max(stats_list[[4]])))
polygon(c(wv, rev(wv)), c(stats_list[[4]], rev(stats_list[[5]])),
col = 'grey80',
lty = 0)
lines(wv, stats_list[[3]])
library(spectrolab)
library(lme4)
library(nlme)
library(ggplot2)
library(ggeffects)
library(sjPlot)
library(rlist)
spectra = readRDS('spectra/lichen_spectra.rds')
#spectra = normalize(spectra)
#4 scans per individual cannot be treated as independent in a linear model, so
#I'm taking the mean per individual
spectra = aggregate(spectra, by = meta(spectra)$X, mean, try_keep_txt(mean))
spec_df = as.data.frame(spectra)
int_r2_list = c()
slope_r2_list = c()
age_effect_list = c()
age_97.5_list = c()
age_2.5_list = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
lmm = lmer(sqrt(spec_df[, x]) ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
d = as.data.frame(VarCorr(lmm))
intercept_var = d[1,4]
slope_var = d[2,4]
residual_var = d[4,4]
total_var = sum(intercept_var, slope_var, residual_var)
int_r2 = intercept_var/total_var
int_r2_list = append(int_r2_list, int_r2)
slope_r2 = slope_var/total_var
slope_r2_list = append(slope_r2_list, slope_r2)
age_effect_list = append(age_effect_list, as.numeric(fixef(lmm)[2]))
ci = confint(lmm)
age_2.5_list = append(age_2.5_list, ci[6])
age_97.5_list = append(age_97.5_list, ci[12])
}
stats_list = list()
stats_list = list.append(stats_list, int_r2_list)
stats_list = list.append(stats_list, slope_r2_list)
stats_list = list.append(stats_list, age_effect_list)
stats_list = list.append(stats_list, age_97.5_list)
stats_list = list.append(stats_list, age_2.5_list)
saveRDS(stats_list, 'models/lmm_1_mean.rds')
warnings()
wv = seq(400, 2400, 1)
plot(wv, stats_list[[3]],
type = 'l',
xlab = 'Wavelength (nm)',
ylab = 'Effect of age (log10(age)/sqrt(wavelength))',
ylim = c(min(stats_list[[5]]), max(stats_list[[4]])))
polygon(c(wv, rev(wv)), c(stats_list[[4]], rev(stats_list[[5]])),
col = 'grey80',
lty = 0)
lines(wv, stats_list[[3]])
plot(wv, stats_list[[1]],
type = 'l',
ylab = 'Percent variance explained',
xlab = 'Wavelength (nm)',
col = 'red',
ylim = c(0, 1))
lines(wv, stats_list[[2]], col = 'blue')
legend('topright',
c('Intercept', 'Slope'),
col = c('red', 'blue'), lty = c(1,1))
library(spectrolab)
library(lme4)
library(nlme)
library(ggplot2)
library(ggeffects)
library(sjPlot)
library(rlist)
spectra = readRDS('spectra/lichen_spectra.rds')
#spectra = normalize(spectra)
#4 scans per individual cannot be treated as independent in a linear model, so
#I'm taking the mean per individual
#spectra = aggregate(spectra, by = meta(spectra)$X, mean, try_keep_txt(mean))
spec_df = as.data.frame(spectra)
spec_scaled = scale(spectra[,400], center = T, scale = T)
lmm = lmer(spec_scaled ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
AIC(lmm)
lmm2 = lmer(sqrt(spec_df[, 400]) ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
AIC(lmm2)
lmm3 = lmer(spec_scaled ~ spec_df$age + (spec_df$age|spec_df$scientificName))
spec_df$scaled_age = scale(spec_df$age, scale = T, center = T)
summary(lmm)
lmm1 = lmer(spec_scaled ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
lmm2 = lmer(sqrt(spec_df[, 400]) ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
lmm3 = lmer(spec_scaled ~ spec_df$age + (spec_df$age|spec_df$scientificName)) #fails
lmm4 = lmer(spec_scaled ~ spec_df$scaled_age + (spec_df$scaled_age|spec_df$scientificName))
lmm5 = lmer(sqrt(spec_scaled) ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
AIC(lmm1)
AIC(lmm2)
AIC(lmm3)
AIC(lmm4)
AIC(lmm5)
hist(spec_scaled)
hist(sqrt(spec_scaled))
hist(log10(spec_scaled))
lmm6 = lmer(spec_scaled ~ sqrt(spec_df$age) + (sqrt(spec_df$age)|spec_df$scientificName))
lmm7 = lmer(spec_scaled ~ spec_df$age + (spec_df$age|spec_df$scientificName))
lmm1 = lmer(spec_scaled ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
spectra = readRDS('spectra/lichen_spectra.rds')
#spectra = normalize(spectra)
#4 scans per individual cannot be treated as independent in a linear model, so
#I'm taking the mean per individual
#spectra = aggregate(spectra, by = meta(spectra)$X, mean, try_keep_txt(mean))
spec_df = as.data.frame(spectra)
int_r2_list = c()
slope_r2_list = c()
age_effect_list = c()
age_97.5_list = c()
age_2.5_list = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
spec_scaled = scale(spectra[,x], center = T, scale = T)
lmm = lmer(spec_scaled ~ log10(spec_df$age) + (log10(spec_df$age)|spec_df$scientificName))
d = as.data.frame(VarCorr(lmm))
intercept_var = d[1,4]
slope_var = d[2,4]
residual_var = d[4,4]
total_var = sum(intercept_var, slope_var, residual_var)
int_r2 = intercept_var/total_var
int_r2_list = append(int_r2_list, int_r2)
slope_r2 = slope_var/total_var
slope_r2_list = append(slope_r2_list, slope_r2)
age_effect_list = append(age_effect_list, as.numeric(fixef(lmm)[2]))
ci = confint(lmm)
age_2.5_list = append(age_2.5_list, ci[6])
age_97.5_list = append(age_97.5_list, ci[12])
}
stats_list = list()
stats_list = list.append(stats_list, int_r2_list)
stats_list = list.append(stats_list, slope_r2_list)
stats_list = list.append(stats_list, age_effect_list)
stats_list = list.append(stats_list, age_97.5_list)
stats_list = list.append(stats_list, age_2.5_list)
saveRDS(stats_list, 'models/lmm_scaled.rds')
wv = seq(400, 2400, 1)
plot(wv, stats_list[[3]],
type = 'l',
xlab = 'Wavelength (nm)',
ylab = 'Effect of age (log10(age)/sqrt(wavelength))',
ylim = c(min(stats_list[[5]]), max(stats_list[[4]])))
polygon(c(wv, rev(wv)), c(stats_list[[4]], rev(stats_list[[5]])),
col = 'grey80',
lty = 0)
lines(wv, stats_list[[3]])
plot(wv, stats_list[[1]],
type = 'l',
ylab = 'Percent variance explained',
xlab = 'Wavelength (nm)',
col = 'red',
ylim = c(0, 1))
lines(wv, stats_list[[2]], col = 'blue')
legend('topright',
c('Intercept', 'Slope'),
col = c('red', 'blue'), lty = c(1,1))
library(corrplot)
library(matrixStats)
library(naniar)
library(spectrolab)
################################################################################
#run plsda
################################################################################
spectra = readRDS('spectra/lichen_spectra.rds')
classify = readRDS("functions/plsda.rds")
pls = classify(spectra = spectra,
className = "Order",
ncomp = 57,
resampling = 'up',
n_iteration = 100,
include_age = T)
saveRDS(pls, 'models/order_age.rds')
library(spectrolab)
library(lme4)
library(nlme)
library(ggplot2)
library(ggeffects)
library(sjPlot)
library(rlist)
library(spectrolab)
library(lme4)
library(nlme)
library(ggplot2)
library(ggeffects)
library(sjPlot)
library(rlist)
library(optimx)
################################################################################
#Report desired statistics from all wavelengths
################################################################################
spectra = readRDS('spectra/lichen_spectra.rds')
spectra = spectra[meta(spectra)$age <= 60, ]
spec_df = as.data.frame(spectra)
spec_df$age = scale(spec_df$age, center = TRUE, scale = TRUE)
varSlope_aic = c()
fixedSlope_aic = c()
for(i in seq(400, 2400, 10)) {
x = toString(i)
lmm_varSlope = lmer(spec_df[, x] ~ age + (age|Class/Order/scientficName), data = spec_df, REML = T,
lmerControl(
optimizer ='optimx', optCtrl=list(method='nlminb')))
lmm_fixedSlope = lmer(spec_df[, x] ~ age + (1|Class/Order/scientficName), data = spec_df, REML = T,
control = lmerControl(
optimizer ='optimx', optCtrl=list(method='nlminb')))
varSlope_aic = append(varSlope_aic, AIC(lmm_varSlope))
fixedSlope_aic = append(fixedSlope_aic, AIC(lmm_fixedSlope))
}
for(i in seq(400, 2400, 10)) {
x = toString(i)
lmm_varSlope = lmer(spec_df[, x] ~ age + (age|Class/Order/scientificName), data = spec_df, REML = T,
lmerControl(
optimizer ='optimx', optCtrl=list(method='nlminb')))
lmm_fixedSlope = lmer(spec_df[, x] ~ age + (1|Class/Order/scientificName), data = spec_df, REML = T,
control = lmerControl(
optimizer ='optimx', optCtrl=list(method='nlminb')))
varSlope_aic = append(varSlope_aic, AIC(lmm_varSlope))
fixedSlope_aic = append(fixedSlope_aic, AIC(lmm_fixedSlope))
}
spectra = readRDS('spectra/lichen_spectra.rds')
spectra = spectra[meta(spectra)$age <= 60, ]
spec_df = as.data.frame(spectra)
spec_df$age = scale(spec_df$age, center = TRUE, scale = TRUE)
varSlope_aic = c()
fixedSlope_aic = c()
for(i in seq(400, 2400, 10)) {
x = toString(i)
#lmm_varSlope = lmer(spec_df[, x] ~ age + (age|Class/Order/scientificName), data = spec_df, REML = T,
# lmerControl(
#optimizer ='optimx', optCtrl=list(method='nlminb')))
lmm_fixedSlope = lmer(spec_df[, x] ~ age + (1|Class/Order/scientificName), data = spec_df, REML = T,
control = lmerControl(
optimizer ='optimx', optCtrl=list(method='nlminb')))
#varSlope_aic = append(varSlope_aic, AIC(lmm_varSlope))
fixedSlope_aic = append(fixedSlope_aic, AIC(lmm_fixedSlope))
}
install.packages('blme')
################################################################################
#Bayesian approach
################################################################################
library(blme)
spectra = readRDS('spectra/lichen_spectra.rds')
spectra = spectra[meta(spectra)$age <= 60, ]
spec_df = as.data.frame(spectra)
spec_df$age = scale(spec_df$age, center = TRUE, scale = TRUE)
lmm = blmer(spec_df[, '700'] ~ age + (age|Family), data = spec_df, REML = T)
lmm = blmer(spec_df[, '700'] ~ age + (age|scientificName), data = spec_df, REML = T)
lmm = blmer(spec_df[, '700'] ~ age + (age|scientificName), data = spec_df, REML = T,
control = lmerControl(
optimizer ='optimx', optCtrl=list(method='nlminb')))
summary(lmm)
