trControl = ctrl,
tuneLength = 2)
AIC(plsFit)
AIC(plsFit$modelInfo)
AIC(plsFit$finalModel)
plsFit$method
plsFit$modelInfo
plsFit$modelType
plsFit$results
plsFit$pred
plsFit$bestTune
plsFit$call
plsFit$dots
plsFit$metric
plsFit$control
AIC(plsFit$finalModel$model)
plsFit$finalModel$model
plsFit$finalModel$coefficients
plsFit$finalModel$projection
classify = function(spectra, className, ncomp, resampling, n_iteration, include_age) {
#require packages
require(spectrolab)
require(caret)
require(dplyr)
require(rlist)
require(matrixStats)
require(mlbench)
#load spectra and convert to matrix and dataframe
spec_all = spectra
spec_mat = as.matrix(spec_all)
spec_all.df = as.data.frame(spec_all)
#combine relevant meta data to matrix
spec_df = as.data.frame(spec_mat)
spec_df = cbind(spec_df, spec_all.df[className])
colnames(spec_df)[colnames(spec_df) == className] <- className
uniqueNames = unique(spec_all.df[[className]])
if (include_age == TRUE) {
spec_df$age = spec_all.df$age
}
##################
#Run PLSDA
##################
#create vectors, lists, and matrices to store metrics and variable importance
accuracy = c()
kappa = c()
a.fit = matrix(nrow = ncomp)
cm.list = list()
vip.list = list()
results = list()
model.list = list()
#create variable importance matrix for each class
for(j in 1:length(uniqueNames)){
name = paste(uniqueNames[j], "vip", sep = ".")
vip.list = list.append(vip.list, assign(name, matrix(nrow = ncol(spec_df)-1)))
}
#start of PLSDA code
for(i in 1:n_iteration){
#create data partition: 70% of data for training, 30% for testing
inTrain <- caret::createDataPartition(
y = spec_df[[className]],
p = .7,
list = FALSE
)
training <- spec_df[inTrain,]
testing <- spec_df[-inTrain,]
#tune model: 10-fold cross-validation repeated 3 times
ctrl <- trainControl(
method = "repeatedcv",
number = 10,
sampling = resampling,
repeats = 3)
#Fit model. Note max iterations set to 100000 to allow model convergence
plsFit <- train(
as.formula(paste(className, "~ .")),
data = training,
maxit = 100000,
method = "pls",
trControl = ctrl,
tuneLength = ncomp)
#variable importance
vip = varImp(plsFit)
for (k in 1:length(uniqueNames)) {
class.vip = assign(paste0(uniqueNames[k], i), vip$importance[uniqueNames[k]])
vip.list[[k]] = cbind(vip.list[[k]], get('class.vip'))
}
#accuracy objects for determining n components
a = assign(paste0('a', i), as.matrix(plsFit$results$Accuracy))
a.fit <- cbind(a.fit, get('a'))
#test model using the testing data partition (20% of data)
plsClasses <- predict(plsFit, newdata = testing)
#confusion/classification matrix objects to assess accuracy
cm = confusionMatrix(data = plsClasses, as.factor(testing[[className]]))
cm.m = assign(paste0("cm", i), as.matrix(cm))
cm.list <- list.append(cm.list, get('cm.m'))
ac <- assign(paste0('acc',i), cm$overall[1])
accuracy <- append(accuracy, get('ac'))
kap = assign(paste0("kap",i), cm$overall[2])
kappa <- append(kappa, get('kap'))
}
results = list.append(results, vip.list)
results = list.append(results, a.fit)
results = list.append(results, cm.list)
results = list.append(results, accuracy)
results = list.append(results, kappa)
return(results)
}
saveRDS(classify, "functions/plsda.rds")
gc()
library(corrplot)
library(matrixStats)
library(naniar)
library(spectrolab)
################################################################################
#run plsda
################################################################################
spectra = readRDS('spectra/lichen_spectra.rds')
classify = readRDS("functions/plsda.rds")
pls = classify(spectra = spectra,
className = "scientificName",
ncomp = 32,
resampling = 'up',
n_iteration = 100,
include_age = TRUE)
saveRDS(pls, 'models/species_age.rds')
library(corrplot)
library(matrixStats)
library(naniar)
library(spectrolab)
################################################################################
#run plsda
################################################################################
spectra = readRDS('spectra/lichen_spectra.rds')
classify = readRDS("functions/plsda.rds")
d = meta(spectra)
View(d)
pls = classify(spectra = spectra,
className = "Family",
ncomp = 60,
resampling = 'down',
n_iteration = 100,
include_age = F)
saveRDS(pls, 'models/family.rds')
accuracy = pls[[4]]
mean(accuracy)
sd(accuracy)
kappa = pls[[5]]
mean(kappa)
sd(kappa)
a.fit = pls[[2]]
a.total = a.fit[,-1]
a.avg = as.matrix(rowMeans(a.total))
a.sd = as.matrix(rowSds(a.total))
a.lower = a.avg - a.sd
a.higher = a.avg + a.sd
#Graph to visually choose optimal number of components
x = 1:50
par(mar = c(5.1, 4.1, 4.1, 2.1), oma = c(5.1, 4.1, 4.1, 2.1))
plot(x, a.avg, type = 'p', pch = 16, cex = .75, ylab = 'Accuracy',
xlab = 'Component', xlim = c(1,50), main = 'Accuracy for Species_ID',
ylim = c(0,1))
arrows(x, a.lower, x, a.higher,length=0.05, angle=90, code=3)
abline(v = which.max(a.avg), col = 'blue')
abline(h = max(a.avg), col = "Red")
legend('bottomright', legend = c('Mean', 'Maximum accuracy','Best component'),
pch = c(16, NA, NA), lty = c(NA, 1, 1), col = c('black', 'red', 'blue'))
#Graph to visually choose optimal number of components
x = 1:60
par(mar = c(5.1, 4.1, 4.1, 2.1), oma = c(5.1, 4.1, 4.1, 2.1))
plot(x, a.avg, type = 'p', pch = 16, cex = .75, ylab = 'Accuracy',
xlab = 'Component', xlim = c(1,50), main = 'Accuracy for Species_ID',
ylim = c(0,1))
arrows(x, a.lower, x, a.higher,length=0.05, angle=90, code=3)
abline(v = which.max(a.avg), col = 'blue')
abline(h = max(a.avg), col = "Red")
legend('bottomright', legend = c('Mean', 'Maximum accuracy','Best component'),
pch = c(16, NA, NA), lty = c(NA, 1, 1), col = c('black', 'red', 'blue'))
x = 1:60
par(mar = c(5.1, 4.1, 4.1, 2.1), oma = c(5.1, 4.1, 4.1, 2.1))
plot(x, a.avg, type = 'p', pch = 16, cex = .75, ylab = 'Accuracy',
xlab = 'Component', xlim = c(1,60), main = 'Accuracy for Species_ID',
ylim = c(0,1))
arrows(x, a.lower, x, a.higher,length=0.05, angle=90, code=3)
abline(v = which.max(a.avg), col = 'blue')
abline(h = max(a.avg), col = "Red")
legend('bottomright', legend = c('Mean', 'Maximum accuracy','Best component'),
pch = c(16, NA, NA), lty = c(NA, 1, 1), col = c('black', 'red', 'blue'))
spectra = readRDS('spectra/lichen_spectra.rds')
classify = readRDS("functions/plsda.rds")
pls = classify(spectra = spectra,
className = "Family",
ncomp = 60,
resampling = 'up',
n_iteration = 100,
include_age = F)
saveRDS(pls, 'models/family.rds')
accuracy = pls[[4]]
mean(accuracy)
sd(accuracy)
kappa = pls[[5]]
mean(kappa)
sd(kappa)
################################################################################
library(corrplot)
library(matrixStats)
library(naniar)
library(spectrolab)
pls = readRDS('models/family.rds')
cm.list = pls[[3]]
cm.avg = Reduce('+', cm.list)/100
cm.avg = t(cm.avg)
cm.total = cm.avg/rowSums(cm.avg)
#standard deviations
f1 <- function(lst){
n <- length(lst);
rc <- dim(lst[[1]]);
ar1 <- array(unlist(lst), c(rc, n));
round(apply(ar1, c(1, 2), sd), 2);
}
cm.sd = f1(cm.list)
cm.sd = t(cm.sd)
cm.sd = cm.sd/rowSums(cm.avg)
rownames(cm.sd) = rownames(as.matrix(cm.list[[1]]))
colnames(cm.sd) = colnames(as.matrix(cm.list[[1]]))
write.csv(cm.sd, file = 'figures/confusion_matrices/standard deviations/Family_sd.csv')
#format matrix for plotting
cm.total = as.data.frame(cm.total)
cm.total = cm.total %>% replace_with_na_all(condition = ~.x == 0)
cm.total = as.matrix(cm.total)
rownames(cm.total) = rownames(as.matrix(cm.list[[1]]))
colnames(cm.total) = colnames(as.matrix(cm.list[[1]]))
#save confusion matrix
write.csv(cm.total, "figures/confusion_matrices/cm_csv/Family.csv")
#plot confusion matrix
cols = colorRampPalette(c('white', '#fe9929'))
par(mfrow = c(1,1))
corrplot::corrplot(as.matrix(cm.total),
method = 'square',
tl.col = 'black',
cl.lim = c(0,1),
na.label = 'square',
na.label.col = 'white',
col = cols(10))
vip_to_spec = function(x){
t.vip = t(x[,-1])
colnames(t.vip) <- gsub("`", "", colnames(t.vip))
s.vip = as_spectra(t.vip)
plot(mean(s.vip), lwd = 1.5, lty = 1, ylim = c(0, 100),
ylab = "Variable Importance", xlab = "Wavelength (nm)", cex.lab = 1,
main = names(s.vip)[1])
plot_quantile(s.vip, total_prob = 0.95, col = rgb(0, 0, 0, 0.25),
border = FALSE, add = TRUE)
}
vip.list = pls[[1]]
par(mfrow = c(3,5))
for (j in 1:length(vip.list)) {
vip_to_spec(vip.list[[j]])
}
library(spectrolab)
library(rlist)
library(splines)
spectra = readRDS('spectra/lichen_spectra.rds')
head(meta(spectra))
spec = spectra[meta(spectra)$scientficName == 'Flavoparmelia_caperata', ]
spec = spectra[meta(spectra)$scientificName == 'Flavoparmelia_caperata',]
spec = spec[, 700]
plot(spec)
spec_df = as.data.frame(spec)
spec_m = as.data.frame(as.matrix(spec))
spec_m$age = spec_df$age
head(spec_m)
View(spec_m)
View(spec_df)
spectra = readRDS('spectra/lichen_spectra.rds')
spec = spectra[meta(spectra)$scientificName == 'Flavoparmelia_caperata',]
spec700 = spec[, 700]
spec_df = as.data.frame(spec)
spec_m = as.data.frame(as.matrix(spec700))
spec_m$age = spec_df$age
View(spec_m)
spectra = readRDS('spectra/lichen_spectra.rds')
spec = spectra[meta(spectra)$scientificName == 'Flavoparmelia_caperata',]
spec700 = spec[, 700]
spec_df = as.data.frame(spec)
spec_m = as.data.frame(as.matrix(spec700))
colnames(spec_m) =  'ref'
spec_m$age = spec_df$age
View(spec_m)
linear = lm(ref~age, data = spec_m)
plot(linear)
plot(spec700)
expon = lm(log(ref)~age, data = spec_m)
plot(expon)
AIC(expon)
AIC(linear)
min(spec_df$age)
max(spec_df$age)
timevalues <- seq(0, 123, 1)
expon2 <- exp(predict(expon, list(age=timevalues)))
plot(spec_m$age, spec_m$ref, pch=16)
lines(timevalues, expon2,lwd=2, col = "red", xlab = "Age (years)", ylab = "Reflectance")
linear2 = predict(linear, list(age=timevalues))
lines(timevalues, linear2, lwd=2, col = 'blue')
expon2 <- predict(expon, list(age=timevalues))
lines(timevalues, expon2,lwd=2, col = "red")
expon = lm(log(ref)~age, data = spec_m)
expon2 <- predict(expon, list(age=timevalues))
lines(timevalues, expon2,lwd=2, col = "red")
ns?s
ns?
>
?ns
sp = lm(ref ~ ns(age, df = 3), data = spec_m)
lines(timevalues, predict(sp, data.frame(age = timevalues)), col = 'green')
AIC(sp)
AIC(liniar)
AIC(linear)
sp = lm(ref ~ ns(age, df = 2), data = spec_m)
lines(timevalues, predict(sp, data.frame(age = timevalues)), col = 'green')
sp = lm(ref ~ ns(age, df = 1), data = spec_m)
lines(timevalues, predict(sp, data.frame(age = timevalues)), col = 'green')
sp = lm(ref ~ ns(age, df = 6), data = spec_m)
plot(spec_m$age, spec_m$ref, pch=16, xlab = "Age (years)", ylab = "Reflectance")
lines(timevalues, expon2,lwd=2, col = "red")
lines(timevalues, linear2, lwd=2, col = 'blue')
lines(timevalues, predict(sp, data.frame(age = timevalues)), col = 'green')
expon2 <- exp(predict(expon, list(age=timevalues)))
lines(timevalues, expon2,lwd=2, col = "red")
AIC(sp)
?exp
spec_m = spec_m[spec_m$age <= 60,]
max(spec_m$age)
spectra = readRDS('spectra/lichen_spectra.rds')
spec = spectra[meta(spectra)$scientificName == 'Flavoparmelia_caperata',]
spec700 = spec[, 700]
spec_df = as.data.frame(spec)
spec_m = as.data.frame(as.matrix(spec700))
colnames(spec_m) =  'ref'
spec_m$age = spec_df$age
spec_m = spec_m[spec_m$age <= 60,]
linear = lm(ref~age, data = spec_m)
expon = lm(log(ref)~age, data = spec_m)
sp = lm(ref ~ ns(age, df = 6), data = spec_m)
timevalues <- seq(0, 123, 1)
expon2 <- exp(predict(expon, list(age=timevalues)))
linear2 = predict(linear, list(age=timevalues))
plot(spec_m$age, spec_m$ref, pch=16, xlab = "Age (years)", ylab = "Reflectance")
lines(timevalues, expon2,lwd=2, col = "red")
lines(timevalues, linear2, lwd=2, col = 'blue')
lines(timevalues, predict(sp, data.frame(age = timevalues)), col = 'green')
AIC(linear)
AIC(expon)
AIC(sp)
spec_df[, '400']
x = 400
spec_df[, x]
y = toString(x)
y
spec_df[, y]
x = toString(400)
linear = lm(x~age, data = spec_df)
linear = lm(spec_df[,x]~ spec_df$age)
x
spectra = readRDS('spectra/lichen_spectra.rds')
spec_df = as.data.frame(spectra)
lin_aic = c()
ex_aic = c()
sp_aic = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
linear = lm(spec_df[, x] ~ spec_df$age)
expon = lm(log(spec_df[, x]) ~ spec_df$age)
sp = lm(spec_df[, x] ~ ns(spec_df$age, df = 6))
lin_aic = append(lin_aic, AIC(linear))
ex_aic = append(ex_aic, AIC(expon))
sp_aic = append(sp_aic, AIC(sp))
}
min(ex_aic)
max(lin_aic)
max(sp_aic)
max(ex_aic)
max = max(c(max(lin_aic), max(ex_aic), max(sp_aic)))
min = min(c(min(lin_aic), min(ex_aic), min(sp_aic)))
wv = seq(400, 2400, 1)
lin = cbind(lin_aic, wv)
View(lin)
plot(lin)
plot(lin$wv, lin$lin_aic)
plot(wv, lin_aic, lty = 1, col = 'blue', ylim = c(min, max), ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, ex_aic, lty = 1, col = 'red' )
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylim = c(min, max), ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, ex_aic, lty = 1, col = 'red' )
lines(wv, sp_aic, lty = 1, col = 'green')
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, sp_aic, lty = 1, col = 'green')
spectra = readRDS('spectra/lichen_spectra.rds')
spec_df = as.data.frame(spectra)
lin_aic = c()
ex_aic = c()
sp_aic = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
linear = lm(spec_df[, x] ~ spec_df$age)
expon = lm(log(spec_df[, x]) ~ spec_df$age)
sp = lm(spec_df[, x] ~ ns(spec_df$age, df = 3))
lin_aic = append(lin_aic, AIC(linear))
ex_aic = append(ex_aic, AIC(expon))
sp_aic = append(sp_aic, AIC(sp))
}
max = max(c(max(lin_aic), max(ex_aic), max(sp_aic)))
min = min(c(min(lin_aic), min(ex_aic), min(sp_aic)))
wv = seq(400, 2400, 1)
#plot all: linear, exponential, spline
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylim = c(min, max), ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, ex_aic, lty = 1, col = 'red' )
lines(wv, sp_aic, lty = 1, col = 'green')
#plot linear and spline AIC
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, sp_aic, lty = 1, col = 'green')
library(spectrolab)
library(rlist)
library(splines)
spectra = readRDS('spectra/lichen_spectra.rds')
spec_df = as.data.frame(spectra)
lin_aic = c()
ex_aic = c()
sp_aic = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
linear = lm(spec_df[, x] ~ spec_df$age)
expon = lm(log(spec_df[, x]) ~ spec_df$age)
sp = lm(spec_df[, x] ~ ns(spec_df$age, df = 3))
lin_aic = append(lin_aic, AIC(linear))
ex_aic = append(ex_aic, AIC(expon))
sp_aic = append(sp_aic, AIC(sp))
}
max = max(c(max(lin_aic), max(ex_aic), max(sp_aic)))
min = min(c(min(lin_aic), min(ex_aic), min(sp_aic)))
wv = seq(400, 2400, 1)
#plot all: linear, exponential, spline
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylim = c(min, max), ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, ex_aic, lty = 1, col = 'red' )
lines(wv, sp_aic, lty = 1, col = 'green')
#plot linear and spline AIC
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, sp_aic, lty = 1, col = 'green')
spectra = readRDS('spectra/lichen_spectra.rds')
spec_df = as.data.frame(spectra)
lin_aic = c()
ex_aic = c()
sp_aic = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
linear = lm(spec_df[, x] ~ spec_df$age)
expon = lm(log(spec_df[, x]) ~ spec_df$age)
sp = lm(spec_df[, x] ~ ns(spec_df$age, df = 6))
lin_aic = append(lin_aic, AIC(linear))
ex_aic = append(ex_aic, AIC(expon))
sp_aic = append(sp_aic, AIC(sp))
}
max = max(c(max(lin_aic), max(ex_aic), max(sp_aic)))
min = min(c(min(lin_aic), min(ex_aic), min(sp_aic)))
wv = seq(400, 2400, 1)
#plot all: linear, exponential, spline
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylim = c(min, max), ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, ex_aic, lty = 1, col = 'red' )
lines(wv, sp_aic, lty = 1, col = 'green')
legend('topright',
legend = c('Linear', 'Exponential', 'Spline'),
lty = 1, col = c('blue', 'red', 'green'))
#plot linear and spline AIC
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, sp_aic, lty = 1, col = 'green')
legend('topright',
legend = c('Linear', 'Spline'),
lty = 1, col = c('blue', 'green'))
spec_df = spec_df[spec_df$age <= 60,]
spectra = readRDS('spectra/lichen_spectra.rds')
spec_df = as.data.frame(spectra)
spec_df = spec_df[spec_df$age <= 60,]
lin_aic = c()
ex_aic = c()
sp_aic = c()
for(i in seq(400, 2400, 1)) {
x = toString(i)
linear = lm(spec_df[, x] ~ spec_df$age)
expon = lm(log(spec_df[, x]) ~ spec_df$age)
sp = lm(spec_df[, x] ~ ns(spec_df$age, df = 6))
lin_aic = append(lin_aic, AIC(linear))
ex_aic = append(ex_aic, AIC(expon))
sp_aic = append(sp_aic, AIC(sp))
}
max = max(c(max(lin_aic), max(ex_aic), max(sp_aic)))
min = min(c(min(lin_aic), min(ex_aic), min(sp_aic)))
wv = seq(400, 2400, 1)
#plot all: linear, exponential, spline
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylim = c(min, max), ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, ex_aic, lty = 1, col = 'red' )
lines(wv, sp_aic, lty = 1, col = 'green')
legend('topright',
legend = c('Linear', 'Exponential', 'Spline'),
lty = 1, col = c('blue', 'red', 'green'))
#plot linear and spline AIC
plot(wv, lin_aic, type='l', lty = 1, col = 'blue', ylab = 'AIC', xlab = 'Wavelength (nm)')
lines(wv, sp_aic, lty = 1, col = 'green')
legend('topright',
legend = c('Linear', 'Spline'),
lty = 1, col = c('blue', 'green'))
t = 'scientificName'
unique(spec_df[, t])
testName = unique(spec_df[, t])[1]
testName
species_spec = spec_df[spec_df[, t] == testName,]
